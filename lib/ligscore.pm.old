package ligscore;
use base qw(saliweb::frontend);
use strict;

sub new {
    return saliweb::frontend::new(@_, @CONFIG@);
}

sub get_navigation_links {
    my $self = shift;
    my $q = $self->cgi;
    return [
        $q->a({-href=>$self->index_url}, "Ligand Score Home"),
        $q->a({-href=>$self->queue_url}, "Ligand Score Current queue"),
        $q->a({-href=>$self->help_url}, "Ligand Score Help"),
        $q->a({-href=>$self->contact_url}, "Ligand Score Contact")
        ];
}

sub get_project_menu {
}

sub get_footer {
  return "<hr size='2' width=\"80%\"><div id='address'> Fan H, Schneidman-Duhovny D, Irwin J, Dong GQ, Shoichet B, Sali A. Statistical Potential for Modeling and Ranking of Protein-Ligand Interactions.
    <p> <p>Contact: <script>escramble(\"hfan\",\"salilab.org\")</script><br></div>\n";
}

sub get_index_page {
    my $self = shift;
    my $q = $self->cgi;

    my $ScoreTypeValues = ['Pose', 'Rank'];
    my $greeting = <<GREETING;
<p>Protein-Ligand Score is a web server for scoring protein-ligand complex structures.
<br />&nbsp;</p>
GREETING
    return "<div id=\"resulttable\">\n" .
           $q->h2(" Protein-Ligand Score: Scoring of Protein-ligand Complex Structures") .
           $q->start_form({-name=>"ligscoreform", -method=>"post",
                           -action=>$self->submit_url}) .
           $q->table(
               $q->Tr($q->td({-colspan=>2}, $greeting)) .
               $q->Tr($q->td($q->h3("General information",
                                    $self->help_link("general")))) .
               $q->Tr($q->td("Email address",
                             $self->help_link("email")),
                      $q->td($q->textfield({-name=>"email",
                                            -value=>$self->email,
                                            -size=>"25"}))) .
               $q->Tr($q->td("Upload protein coordinate file (pdb)",
                             $self->help_link("file"), $q->br),
                      $q->td($q->filefield({-name=>"recfile"}))) . 
               $q->Tr($q->td("Upload ligand coordinate file (mol2)",
                             $self->help_link("file"), $q->br),
                      $q->td($q->filefield({-name=>"ligfile"}))) . 
               $q->Tr($q->td($q->h3("Name your score file",
                                    $self->help_link("name"))),
                      $q->td($q->textfield({-name=>"name",
                                            -value=>"score.list", -size=>"9"}))) .
               $q->Tr($q->td("Score type",
                             $self->help_link("scoretype"),
                             $q->td($q->popup_menu("scoretype", $ScoreTypeValues)))) .
               $q->Tr($q->td({-colspan=>"2"},
                             "<center>" .
                             $q->input({-type=>"submit", -value=>"Submit"}) .
                             $q->input({-type=>"reset", -value=>"Reset"}) .
                             "</center><p>&nbsp;</p>"))) .
           $q->end_form .
           "</div>\n"; 
}

sub get_submit_page {
  my $self = shift;
  my $q = $self->cgi;
  print $q->header();
  my $recfile = $q->param("recfile");
  my $ligfile = $q->param("ligfile");
  my $email = $q->param('email');
 
  check_required_email($email);

  my $scoretype = $q->param("scoretype");

  if($scoretype eq "Pose") { $scoretype = "PoseScore.lib"; }
  else {
    if($scoretype eq "Rank") { $scoretype = "RankScore.lib"; }
    else {
        throw saliweb::frontend::InputValidationError("Error in the types of scoring<p>");
    }
  }

  #create job directory time_stamp
  my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime;
  my $time_stamp = $sec."_".$min."_".$hour."_".$mday."_".$mon."_".$year;
  my $job = $self->make_job($time_stamp, $self->email);
  my $jobdir = $job->directory;

  my $recFileUsed = 0;
  my $ligFileUsed = 0;

  my $receptorFileName = "";
  my $ligandFileName = "";

  #receptor molecule
  if(length $recfile > 0) {
    $recFileUsed = 1;
    $recfile =~ s/.*[\/\\](.*)/$1/;
    $recfile = removeSpecialChars($recfile);
    my $rupload_filehandle = $q->upload("recfile");
    open UPLOADFILE, ">$jobdir/$recfile";
    while ( <$rupload_filehandle> ) { print UPLOADFILE; }
    close UPLOADFILE;
    my $filesize = -s "$jobdir/$recfile";
    if($filesize == 0) {
      throw saliweb::frontend::InputValidationError("You have uploaded an empty file: $recfile");
    }
    $receptorFileName = $recfile;
  } else {
    throw saliweb::frontend::InputValidationError("Error in receptor molecule input: please upload receptor PDB file as *.pdb");
  }

  #ligand molecule
  if(length $ligfile > 0) {
    $ligFileUsed = 1;
    $ligfile =~ s/.*[\/\\](.*)/$1/;
    $ligfile = removeSpecialChars($ligfile);
    my $lupload_filehandle = $q->upload("ligfile");
    open UPLOADFILE, ">$jobdir/$ligfile";
    while ( <$lupload_filehandle> ) { print UPLOADFILE; }
    close UPLOADFILE;
    my $filesize = -s "$jobdir/$ligfile";
    if($filesize == 0) {
      throw saliweb::frontend::InputValidationError("You have uploaded an empty file: $ligfile");
    }
    $ligandFileName = $ligfile;
  } else {
    throw saliweb::frontend::InputValidationError("Error in ligand molecule input: please specify PDB code or upload file");
  }

  my $input_line = $jobdir . "/input.txt";
  open(INFILE, "> $input_line")
    or throw saliweb::frontend::InternalError("Cannot open $input_line: $!");
  print INFILE "$receptorFileName $ligandFileName $scoretype\n";

  $job->submit($email);

  # Inform the user of the job name and results URL
  return $q->p("Your job has been submitted with job ID " . $job->name) .
    #$q->p("Results will be found at <a href=\"" . $job->results_url . "\">this link</a>.");
    $q->p("You will receive an e-mail with results link once the job has finished");
}

sub get_results_page {
  my ($self, $job) = @_;
  my $q = $self->cgi;

  my $return = '';
  my $jobname = $job->name;
  my $joburl = $job->results_url;
#  my $passwd = $q->param('passwd');
  my $from = $q->param('from');
  my $to = $q->param('to');
  if(length $from == 0) { $from = 1; $to = 20; }

  $return .= print_input_data($job);
  if(-f 'score.list') {
    $return .= display_output_table($joburl, $from, $to);
    $return .= $q->p("<a href=\"" . $job->get_results_file_url('score.list') . "\">Download output file</a>.");
  } else {
    $return .= $q->p("No output file was produced. Please inspect the log files to determine the problem.");
    $return .= $q->p("<a href=\"" . $job->get_results_file_url('score.log') . "\">View score log file</a>.");
  }
  #$return .= $job->get_results_available_time();
  return $return; 
}

sub display_output_table {
  #my ($self, $job) = @_;
  my $joburl = shift;
  my $first = shift;
  my $last = shift;
  my $return = "";

  $return .= "<hr size=2 width=90%>";
  $return .= print_table_header();

  open(DATA, "score.list");
  my $ligandPdb = "";
  my $receptorPdb = "";
  my $transNum = 0;
  my @colors=("#cccccc","#efefef");
  while(<DATA>) {
    chomp;
    my @tmp=split;
    if($#tmp>0) {
      $transNum++;
      if($transNum >= $first and $transNum <= $last) {
        my $score = sprintf("%.2f", $tmp[1]);

        my $color = $colors[$transNum % 2];
        $return .= "<tr bgcolor=$color><td>$transNum</td>
                                <td>$score</td>";
        # generate PDB link
        # my $pdb_joburl = $joburl;
        # $pdb_joburl =~ s/results/model/;
        # my $pdb_url = $pdb_joburl . "&from=$transNum&to=$transNum";
        # $return .= "<td> <a href=\"" . $pdb_url . "\"> result$transNum.pdb </a></td>";
        # generate link to model page
        # my $model_url = $pdb_url;
        # $model_url =~ s/model/model2/;
        # $return .= "<td> <a href=\"" . $model_url . "\"> view </a></td>";
        # $return .= "</tr>";
      }
    }
  }

  # links to previous and next twenty results
  $return .= "<tr><td>";
 if($first > 20) {
    my $prev_from = $first - 20;
    my $prev_to = $last - 20;
    my $prev_page_url = $joburl . "&from=$prev_from&to=$prev_to";
    $return .= "<a href=\"" . $prev_page_url . "\">&laquo;&laquo; show prev 20 </a>";
  }
  $return .= "</td><td></td><td></td><td></td><td></td><td>";
  if($last < $transNum) {
    my $next_from = $first + 20;
    my $next_to = $last + 20;
    my $next_page_url = $joburl . "&from=$next_from&to=$next_to";
    $return .= "<a href=\"" . $next_page_url . "\">&raquo;&raquo; show next 20 </a>";
  }
  $return .= "</td></tr></table>";
  return $return;
}

sub print_table_header() {
return "
<table cellspacing=\"0\" cellpadding=\"0\" width=\"90%\" align=center>
<tr>
<td><font color=blue><b>Model No</b></td>
<td><font color=blue><b>Score</b></td>
</tr>
";
}

sub print_input_data() {
  my $job = shift;
    
  my $filename = "input.txt";
  open FILE, "<$filename" or die "Can't open file: $filename";
  my @dataFile = <FILE>;
  my $dataLine = $dataFile[0];
  chomp($dataLine);
  my @data = split(' ',$dataLine);
  
  my $receptor_url = $job->get_results_file_url($data[0]);
  my $ligand_url = $job->get_results_file_url($data[1]);
  my $scoretype_url = $job->get_results_file_url($data[2]);
    
  my $return = "<table width=\"90%\"><tr>
<td><font color=blue>Receptor</td>
<td><font color=blue>Ligand</td>
<td><font color=blue>Score Type</td>
</tr>";

  $return .= "<tr><td><a href=\"". $receptor_url . "\">  $data[0] </a> </td> " .
    " <td><a href=\"". $ligand_url . "\"> $data[1] </a> </td> " ." <td><a href=\"". $scoretype_url . "\"> $data[2] </a> </td> ";
  return $return;
}

sub removeSpecialChars {
  my $str = shift;
  $str =~ s/[^\w,^\d,^\.]//g;
  return $str;
}

sub check_required_email {
  my ($email) = @_;
  if($email !~ m/^[\w\.-]+@[\w-]+\.[\w-]+((\.[\w-]+)*)?$/ ) {
    throw saliweb::frontend::InputValidationError("Please provide a valid return email address");
  }
}

1;
